# Maintainer: Albert I <kras@raphielgang.org>
# Contributor: Felix Yan <felixonmars@archlinux.org>
# Contributor: Andrea Scarpino <andrea@archlinux.org>
# Contributor: Pierre Schmitz <pierre@archlinux.de>

pkgname=cmake3
pkgver=3.31.8
pkgrel=1
pkgdesc='A cross-platform open-source make system (release 3.x)'
arch=(x86_64)
url='https://www.cmake.org/'
license=(BSD-3-Clause)
depends=(
    bash
    cppdap
    curl libcurl.so
    expat libexpat.so
    gcc-libs
    glibc
    hicolor-icon-theme
    jsoncpp libjsoncpp.so
    libarchive libarchive.so
    libuv
    ncurses libformw.so libncursesw.so
    rhash
    zlib libz.so
)
makedepends=(
    emacs
    git
    nlohmann-json
    python-sphinx
    qt6-base
)
optdepends=(
    'make: for unix Makefile generator'
    'ninja: for ninja generator'
    'qt6-base: cmake-gui'
)
provides=("cmake=${pkgver}")
conflicts=(cmake)
source=(git+https://gitlab.kitware.com/cmake/cmake.git#tag=v$pkgver?signed)
sha384sums=('4eccc1fa7ae8368449f5d157504ad12d77b2a2a160ee89ca0eee9de7b671ca3acb4ac6dffa7dcf2362e84b421f63b897')
b2sums=('e409f2f53d9a0cd951855950e387361acd274959966585975f0864e4e9b50f3d933b47319cef944d654ce0092316a310e5ca54a229cfbf97f68c740df206024a')
validpgpkeys=(CBA23971357C2E6590D9EFD3EC8FEF3A7BFB4EDA) # Brad King <brad.king@kitware.com>

build() {
    cd cmake
    ./bootstrap \
        --prefix=/usr \
        --datadir=/share/cmake \
        --docdir=/share/doc/cmake \
        --mandir=/share/man \
        --parallel="$(/usr/bin/getconf _NPROCESSORS_ONLN)" \
        --qt-gui \
        --sphinx-html \
        --sphinx-man \
        --system-libs
    make
}

package() {
    DESTDIR="${pkgdir}" make -C cmake install

    rm -r -v "${pkgdir}/usr/share/doc/cmake/html/_sources"
    emacs -batch -f batch-byte-compile "${pkgdir}/usr/share/emacs/site-lisp/cmake-mode.el"
    install -D -v -m 644 cmake/Copyright.txt "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
